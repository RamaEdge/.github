name: Reusable Container Build

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry path (e.g., harbor.example.com/project)'
        type: string
        required: true
      registry-host:
        description: 'Container registry host for login (e.g., harbor.example.com)'
        type: string
        required: true
      service:
        description: 'Single service to build (directory name under services/)'
        type: string
        required: false
      services:
        description: 'Space-separated list of services to build (directory names under services/)'
        type: string
        required: false
      containerfile-path:
        description: 'Path pattern to Containerfile (use {service} as placeholder)'
        type: string
        default: 'services/{service}/Containerfile'
      build-context:
        description: 'Build context directory'
        type: string
        default: '.'
      trivy-severity:
        description: 'Trivy severity levels to scan'
        type: string
        default: 'CRITICAL,HIGH'
      push-on-tag:
        description: 'Push images when triggered by a tag'
        type: boolean
        default: true
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

jobs:
  build-and-scan:
    name: Build and Scan Containers
    runs-on: arc-runner-set
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify runner tooling
        run: |
          sudo podman --version
          sudo podman info --format '{{.Store.GraphDriverName}}'
          trivy --version

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # Use tag version (keep 'v' prefix)
            VERSION="${{ github.ref_name }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Use PR number and short SHA for PRs
            VERSION="pr-${{ github.event.pull_request.number }}-${GITHUB_SHA::8}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          else
            # Workflow dispatch or other - use short SHA
            VERSION="dev-${GITHUB_SHA::8}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi
          echo "Version: $VERSION"

      - name: Log in to Container Registry
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          if [[ -n "$REGISTRY_USERNAME" && -n "$REGISTRY_PASSWORD" ]]; then
            echo "Logging in to ${{ inputs.registry-host }}..."
            printf '%s' "$REGISTRY_PASSWORD" | sudo podman login \
              --username "$REGISTRY_USERNAME" \
              --password-stdin \
              "${{ inputs.registry-host }}"
            echo "✓ Login successful"
          else
            echo "⚠ Registry credentials not provided, skipping login"
          fi

      - name: Build containers
        id: build
        run: |
          IMAGES=""
          services_list=()
          if [[ -n "${{ inputs.service }}" ]]; then
            services_list=("${{ inputs.service }}")
          elif [[ -n "${{ inputs.services }}" ]]; then
            read -r -a services_list <<< "${{ inputs.services }}"
          fi

          if [[ ${#services_list[@]} -eq 0 ]]; then
            echo "No services specified. Provide 'service' or 'services' input."
            exit 1
          fi

          for service in "${services_list[@]}"; do
            image_name=$(echo $service | tr '_' '-')
            full_image="${{ inputs.registry }}/$image_name:${{ steps.version.outputs.version }}"
            containerfile=$(echo "${{ inputs.containerfile-path }}" | sed "s/{service}/$service/g")
            
            echo "Building $service from $containerfile..."
            sudo podman build --isolation=chroot \
              -f "$containerfile" \
              -t "$full_image" \
              ${{ inputs.build-context }}
            
            # Also tag as latest if this is a tag push
            if [[ "${{ steps.version.outputs.is_tag }}" == "true" ]]; then
              sudo podman tag "$full_image" "${{ inputs.registry }}/$image_name:latest"
            fi
            
            IMAGES="$IMAGES $full_image"
          done
          echo "images=$IMAGES" >> $GITHUB_OUTPUT

      - name: Run Trivy vulnerability scanner
        run: |
          mkdir -p trivy-results
          services_list=()
          if [[ -n "${{ inputs.service }}" ]]; then
            services_list=("${{ inputs.service }}")
          elif [[ -n "${{ inputs.services }}" ]]; then
            read -r -a services_list <<< "${{ inputs.services }}"
          fi

          for service in "${services_list[@]}"; do
            image_name=$(echo $service | tr '_' '-')
            full_image="${{ inputs.registry }}/$image_name:${{ steps.version.outputs.version }}"
            
            echo "Scanning $service with Trivy..."
            image_tar="/tmp/${service}.tar"
            sudo podman save "$full_image" -o "$image_tar"
            if sudo trivy image \
              --input "$image_tar" \
              --format sarif \
              --output "trivy-results/$service.sarif" \
              --severity ${{ inputs.trivy-severity }}; then
              echo "✓ Scan completed for $service"
            else
              echo "⚠ Scan failed for $service, creating empty SARIF..."
              echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > "trivy-results/$service.sarif"
            fi
            sudo rm -f "$image_tar"
          done
          # Fix permissions for upload
          sudo chown -R $(id -u):$(id -g) trivy-results/

      #- name: Upload Trivy results to GitHub Security
      #  uses: github/codeql-action/upload-sarif@v3
      #  if: always()
      #  with:
      #    sarif_file: trivy-results
      #    category: container-security

      - name: Push container images
        if: steps.version.outputs.is_tag == 'true' && inputs.push-on-tag
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        run: |
          if [[ -z "$REGISTRY_USERNAME" ]]; then
            echo "⚠ Registry credentials not provided, skipping push"
            exit 0
          fi
          
          services_list=()
          if [[ -n "${{ inputs.service }}" ]]; then
            services_list=("${{ inputs.service }}")
          elif [[ -n "${{ inputs.services }}" ]]; then
            read -r -a services_list <<< "${{ inputs.services }}"
          fi

          for service in "${services_list[@]}"; do
            image_name=$(echo $service | tr '_' '-')
            versioned_image="${{ inputs.registry }}/$image_name:${{ steps.version.outputs.version }}"
            latest_image="${{ inputs.registry }}/$image_name:latest"
            
            echo "Pushing $versioned_image..."
            sudo podman push "$versioned_image"
            
            echo "Pushing $latest_image..."
            sudo podman push "$latest_image"
          done
